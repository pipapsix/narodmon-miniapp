<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ü–æ–≥–æ–¥–∞ –ù–∞—Ä–æ–¥–º–æ–Ω ‚Äî –ª—é–±–æ–π –≥–æ—Ä–æ–¥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family: sans-serif; padding:20px; background:#000; color:#fff; margin:0;}
    input, button {padding:14px 18px; margin:10px 0; border-radius:14px; font-size:17px; width:100%; box-sizing:border-box;}
    input {background:#111; border:1px solid #333; color:#fff;}
    button {background:#0088cc; border:none; color:white; font-weight:bold;}
    .card {background:#111; padding:16px; border-radius:14px; margin:12px 0;}
    .small {font-size:0.9em; color:#aaa;}
    .loading {color:#0088cc;}
  </style>
</head>
<body>
  <h1>–ü–æ–≥–æ–¥–∞ –ø–æ –¥–∞—Ç—á–∏–∫–∞–º –ù–∞—Ä–æ–¥–º–æ–Ω</h1>
  
  <input type="text" id="city" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–æ—á–∏, –õ–æ–Ω–¥–æ–Ω, –ù—å—é-–ô–æ—Ä–∫‚Ä¶)" autofocus>
  
  <button onclick="search()">–ù–∞–π—Ç–∏ –¥–∞—Ç—á–∏–∫–∏ —Ä—è–¥–æ–º</button>
  <button onclick="getLocation()">–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
  
  <div id="out">–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</div>

<script>
const API_KEY = "WV7RVH19UkqsZ";

async function search() {
  const query = document.getElementById('city').value.trim();
  if (!query) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞');
  
  document.getElementById('out').innerHTML = '<p class="loading">–ò—â—É –≥–æ—Ä–æ–¥ ¬´' + query + '¬ª‚Ä¶</p>';

  try {
    // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ Nominatim (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–µ–π)
    const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=ru,by,kz,ua,am,az,ge,tj,kg,uz,md`);
    const geoData = await geoRes.json();
    
    if (!geoData || geoData.length === 0) throw new Error('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ');

    const lat = parseFloat(geoData[0].lat);
    const lng = parseFloat(geoData[0].lon);
    const cityName = geoData[0].display_name.split(',')[0];

    localStorage.setItem('lastCity', query);
    loadSensors(lat, lng, cityName);
    
  } catch (e) {
    document.getElementById('out').innerHTML = `<b>–û—à–∏–±–∫–∞:</b> ${e.message}`;
  }
}

function getLocation() {
  document.getElementById('out').innerHTML = '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ‚Ä¶';
  Telegram.WebApp.requestLocation();
}

Telegram.WebApp.onEvent('locationReceived', loc => {
  loadSensors(loc.latitude, loc.longitude, '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
});

async function loadSensors(lat, lng, title) {
  document.getElementById('out').innerHTML = '<p class="loading">–ò—â—É –¥–∞—Ç—á–∏–∫–∏ —Ä—è–¥–æ–º‚Ä¶</p>';

  const uuid = 'webapp_' + (Telegram.WebApp.initDataUnsafe.user?.id || Date.now());
  const url = `https://narodmon.ru/api/sensorsNearby?lat=${lat}&lng=${lng}&distance=150&types=1,2,3&api_key=${API_KEY}&uuid=${uuid}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    const sensors = data.sensors || [];
    let html = `<b>${title}</b><br>–ù–∞–π–¥–µ–Ω–æ ${sensors.length} –¥–∞—Ç—á–∏–∫–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 150 –∫–º<br><br>`;

    if (sensors.length === 0) {
      html += '–í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤ –ù–∞—Ä–æ–¥–º–æ–Ω–∞';
    } else {
      sensors.slice(0, 30).forEach(s => {
        const temp = s.value != null ? s.value.toFixed(1) + '¬∞C' : '‚Äî';
        const name = s.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        const dist = s.distance ? s.distance.toFixed(1) + ' –∫–º' : '';
        const time = new Date(s.time * 1000).toLocaleTimeString('ru');

        html += `<div class="card"><b>${name}</b> ${dist}<br>`;
        html += `üå°Ô∏è ${temp}<br>`;
        html += `<span class="small">–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Å–µ–≥–æ–¥–Ω—è –≤ ${time}</span></div>`;
      });
    }
    document.getElementById('out').innerHTML = html;
  } catch (e) {
    document.getElementById('out').innerHTML = `<b>–û—à–∏–±–∫–∞:</b> ${e.message}<br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –¥—Ä—É–≥–æ–π –≥–æ—Ä–æ–¥`;
  }
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≥–æ—Ä–æ–¥–∞
const last = localStorage.getItem('lastCity');
if (last) {
  document.getElementById('city').value = last;
  // –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ
  // search();
}

Telegram.WebApp.ready();
Telegram.WebApp.MainButton.setText('–ù–∞–π—Ç–∏').onClick(search).show();
</script>
</body>
</html>
