<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Narodmon Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family: sans-serif; padding:20px; background:#000; color:#fff; margin:0;}
    button {padding:14px 24px; font-size:16px; border-radius:12px; border:none; background:#0088cc; color:white;}
    pre {background:#111; padding:15px; border-radius:8px; overflow:auto; max-height:70vh;}
  </style>
</head>
<body>
  <h1>–î–∞—Ç—á–∏–∫–∏ —Ä—è–¥–æ–º (–ú–æ—Å–∫–≤–∞)</h1>
  <button onclick="load()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <pre id="out">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Üë</pre>

  <script>
async function load() {
  document.getElementById('out').innerHTML = '–ó–∞–≥—Ä—É–∂–∞—é‚Ä¶';
  try {
    const res = await fetch('https://narodmon.ru/client.php?json');
    const data = await res.json();

    const myLat = 55.7558, myLng = 37.6173;
    const maxDist = 100; // –∫–º

    const nearby = data.devices
      .filter(d => d.lat && d.lng)
      .map(d => {
        const dist = Math.hypot(d.lat - myLat, d.lng - myLng) * 111.2;
        return { ...d, distance: +dist.toFixed(1) };
      })
      .filter(d => d.distance <= maxDist)
      .sort((a, b) => a.distance - b.distance);

    let html = `<b>–ù–∞–π–¥–µ–Ω–æ ${nearby.length} –¥–∞—Ç—á–∏–∫–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ ${maxDist} –∫–º –æ—Ç –ú–æ—Å–∫–≤—ã</b><br><br>`;
    nearby.slice(0, 25).forEach(d => {
      const temp = d.sensors?.find(s => s.type === 1)?.value ?? '‚Äî';
      const hum = d.sensors?.find(s => s.type === 2)?.value ?? '‚Äî';
      html += `<b>${d.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</b> ‚Äî ${d.distance} –∫–º<br>`;
      html += `üå°Ô∏è ${temp}¬∞C‚ÄÉüíß ${hum}%‚ÄÉ‚åö ${new Date(d.time * 1000).toLocaleTimeString('ru')}<br><br>`;
    });

    document.getElementById('out').innerHTML = html;
  } catch (e) {
    document.getElementById('out').textContent = '–û—à–∏–±–∫–∞: ' + e.message;
  }
}

Telegram.WebApp.ready();
Telegram.WebApp.MainButton.setText('–û–±–Ω–æ–≤–∏—Ç—å').onClick(load).show();
load(); // –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
</script>
</body>
</html>
