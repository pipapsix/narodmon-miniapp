<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Погода Народмон</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #000;
      color: #fff;
      margin: 0;
    }
    input, button {
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 12px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    input {
      background: #111;
      border: 1px solid #333;
      color: #fff;
    }
    button {
      background: #0088cc;
      border: none;
      color: white;
    }
    .card {
      background: #111;
      padding: 15px;
      border-radius: 12px;
      margin: 10px 0;
    }
    .small {
      font-size: 0.9em;
      color: #aaa;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .controls > * {
      flex: 1;
      min-width: 120px;
    }
  </style>
</head>
<body>
  <h1>Погода по датчикам Народмон</h1>
  
  <input type="text" id="city" placeholder="Введите город (например: Тула, Калининград)">

  <div class="controls">
    <input type="number" id="radius" min="1" max="200" placeholder="Радиус, км">
    <button onclick="search()">Показать датчики</button>
  </div>

  <button onclick="getLocation()">Найти рядом со мной</button>
  
  <div id="out">Введите город и нажмите «Показать датчики»</div>

<script>
const API_KEY = "WV7RVH19UkqsZ";

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Получаем радиус (с дефолтом 100)
function getRadius() {
  const input = document.getElementById('radius');
  let r = parseInt(input.value) || 100;
  r = Math.max(1, Math.min(200, r)); // Ограничение 1–200
  input.value = r; // Нормализуем значение в поле
  return r;
}

async function search() {
  const cityName = document.getElementById('city').value.trim();
  if (!cityName) return alert('Введите название города');

  const distance = getRadius();
  localStorage.setItem('lastCity', cityName);
  localStorage.setItem('lastRadius', distance);

  document.getElementById('out').innerHTML = 'Определяю координаты города…';

  try {
    const geoUrl = `https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(cityName)}&format=json&limit=1`;
    const geoRes = await fetch(geoUrl, {
      headers: {
        'User-Agent': 'Narodmon-Weather-App / Telegram Mini App'
      }
    });
    const geoData = await geoRes.json();

    if (!geoData || geoData.length === 0) {
      throw new Error('Город не найден. Попробуйте точное название.');
    }

    const lat = parseFloat(geoData[0].lat);
    const lng = parseFloat(geoData[0].lon);

    loadSensors(lat, lng, cityName, distance);
  } catch (e) {
    document.getElementById('out').innerHTML = `<b>Ошибка:</b> ${e.message}<br>Проверьте название или попробуйте позже`;
  }
}

function getLocation() {
  const distance = getRadius();
  localStorage.setItem('lastRadius', distance);
  document.getElementById('out').innerHTML = 'Запрашиваю геолокацию…';
  Telegram.WebApp.requestLocation();
}

Telegram.WebApp.onEvent('locationReceived', loc => {
  const distance = parseInt(localStorage.getItem('lastRadius')) || 100;
  loadSensors(loc.latitude, loc.longitude, 'Ваше местоположение', distance);
});

async function loadSensors(lat, lng, title, distance = 100) {
  document.getElementById('out').innerHTML = `Ищу датчики в радиусе ${distance} км…`;

  const uuid = generateUUID();
  const url = `https://narodmon.ru/api/sensorsNearby?lat=${lat}&lng=${lng}&distance=${distance}&types=1,2,3&api_key=${API_KEY}&uuid=${uuid}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.error) throw new Error(data.error);

    const devices = data.devices || [];
    let html = `<b>${title}</b><br>Найдено ${devices.length} датчиков в радиусе ${distance} км<br><br>`;

    if (devices.length === 0) {
      html += 'В этом районе пока нет активных датчиков.';
    } else {
      devices.slice(0, 30).forEach(d => {
        const tempSensor = d.sensors?.find(s => s.type === 1) || d.sensors?.find(s => s.type_name === 'Температура');
        const temp = tempSensor ? tempSensor.value.toFixed(1) + '°C' : '—';
        const name = d.name || d.title || 'Без названия';
        const dist = d.distance ? d.distance.toFixed(1) + ' км' : '';
        const time = new Date((d.time || d.updated || 0) * 1000).toLocaleString('ru');

        html += `<div class="card"><b>${name}</b> ${dist}<br>`;
        html += `Температура: ${temp}<br>`;
        html += `<span class="small">Обновлено: ${time}</span></div>`;
      });
    }

    document.getElementById('out').innerHTML = html;
  } catch (e) {
    document.getElementById('out').innerHTML = `<b>Ошибка:</b> ${e.message}<br>Проверьте интернет или попробуйте позже`;
  }
}

// Восстановление последних значений
const lastCity = localStorage.getItem('lastCity');
const lastRadius = localStorage.getItem('lastRadius') || '100';

if (lastCity) document.getElementById('city').value = lastCity;
document.getElementById('radius').value = lastRadius;

Telegram.WebApp.ready();
Telegram.WebApp.MainButton.setText('Поиск').onClick(search).show();
</script>
</body>
</html>
