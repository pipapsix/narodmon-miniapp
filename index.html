<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Narodmon Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family: sans-serif; padding:20px; background:#000; color:#fff; margin:0;}
    button {padding:14px 24px; font-size:16px; border-radius:12px; border:none; background:#0088cc; color:white;}
    pre {background:#111; padding:15px; border-radius:8px; overflow:auto; max-height:70vh;}
  </style>
</head>
<body>
  <h1>–î–∞—Ç—á–∏–∫–∏ —Ä—è–¥–æ–º (–ú–æ—Å–∫–≤–∞)</h1>
  <button onclick="load()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <pre id="out">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É ‚Üë</pre>

  <script>
async function load() {
  document.getElementById('out').innerHTML = '–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ù–∞—Ä–æ–¥–º–æ–Ω‚Ä¶';
  try {
    let data;
    let source = '';

    // –ü—Ä–æ–±—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π API
    let res = await fetch('https://narodmon.ru/client.php?json');
    let raw = await res.json();
    if (raw.error) {
      throw new Error('–û—Å–Ω–æ–≤–Ω–æ–π API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É');
    }
    data = raw;
    source = 'narodmon.ru';
    console.log('–î–∞–Ω–Ω—ã–µ —Å ' + source);

    // –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, fallback –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
  } catch (e) {
    console.log('Fallback –Ω–∞ ps.narodmon.ru');
    res = await fetch('https://ps.narodmon.ru/data.json');
    data = await res.json();
    source = 'ps.narodmon.ru';
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±–æ–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤)
  const devices = Array.isArray(data) ? data : (data.devices || []);

  if (!Array.isArray(devices) || devices.length === 0) {
    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç API');
  }

  const myLat = 55.7558;
  const myLng = 37.6173;
  const maxDist = 100; // –∫–º

  const nearby = devices
    .filter(d => d && typeof d === 'object' && d.lat && d.lng)
    .map(d => {
      const dist = Math.hypot(d.lat - myLat, d.lng - myLng) * 111.2;
      return { ...d, distance: +dist.toFixed(1) };
    })
    .filter(d => d.distance <= maxDist)
    .sort((a, b) => a.distance - b.distance);

  let html = `<b>–î–∞–Ω–Ω—ã–µ —Å ${source} | –ù–∞–π–¥–µ–Ω–æ ${nearby.length} –¥–∞—Ç—á–∏–∫–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ ${maxDist} –∫–º –æ—Ç –ú–æ—Å–∫–≤—ã</b><br><br>`;
  
  if (nearby.length === 0) {
    html += '–í —Ä–∞–¥–∏—É—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤. –†–∞—Å—à–∏—Ä—å—Ç–µ —Ä–∞–¥–∏—É—Å –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
  } else {
    nearby.slice(0, 25).forEach(d => {
      const tempSensor = d.sensors?.find(s => s.type === 1) || d.sensors?.find(s => s.type_name === '–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞') || {};
      const humSensor = d.sensors?.find(s => s.type === 2) || d.sensors?.find(s => s.type_name === '–í–ª–∞–∂–Ω–æ—Å—Ç—å') || {};
      const pressSensor = d.sensors?.find(s => s.type === 3) || d.sensors?.find(s => s.type_name === '–î–∞–≤–ª–µ–Ω–∏–µ') || {};
      
      const temp = tempSensor.value ?? '‚Äî';
      const hum = humSensor.value ?? '‚Äî';
      const press = pressSensor.value ?? '‚Äî';
      
      html += `<b>${d.name || d.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</b> ‚Äî ${d.distance} –∫–º<br>`;
      html += `üå°Ô∏è ${temp}¬∞C‚ÄÉüíß ${hum}%‚ÄÉüìä ${press} –º–º.—Ä—Ç.—Å—Ç.<br>`;
      const updateTime = d.time || d.updated || d.last_update;
      html += `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(updateTime * 1000).toLocaleString('ru-RU')}<br><br>`;
    });
  }

  document.getElementById('out').innerHTML = html;
} catch (e) {
  document.getElementById('out').innerHTML = `<b>–û—à–∏–±–∫–∞:</b> ${e.message}<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.`;
}

Telegram.WebApp.ready();
Telegram.WebApp.MainButton.setText('–û–±–Ω–æ–≤–∏—Ç—å').onClick(load).show();
load(); // –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
</script>
</body>
</html>
